load "$NCARG_ROOT/lib/ncarg/nclscripts/csm/shea_util.ncl"
begin

;; Get pressures
fps  = addfile( "PS.2005-2014.4x5.nc4", "r" )

ni = 72
nj = 46

nk_in=72
nki_in=73

nk_out=74
nki_out=75

;; Ap [hPa] for 72 levels (73 edges)
a_in =      (/ 0.000000e+00, 4.804826e-02, 6.593752e+00, 1.313480e+01, \
               1.961311e+01, 2.609201e+01, 3.257081e+01, 3.898201e+01, \
               4.533901e+01, 5.169611e+01, 5.805321e+01, 6.436264e+01, \
               7.062198e+01, 7.883422e+01, 8.909992e+01, 9.936521e+01, \
               1.091817e+02, 1.189586e+02, 1.286959e+02, 1.429100e+02, \
               1.562600e+02, 1.696090e+02, 1.816190e+02, 1.930970e+02, \
               2.032590e+02, 2.121500e+02, 2.187760e+02, 2.238980e+02, \
               2.243630e+02, 2.168650e+02, 2.011920e+02, 1.769300e+02, \
               1.503930e+02, 1.278370e+02, 1.086630e+02, 9.236572e+01, \
               7.851231e+01, 6.660341e+01, 5.638791e+01, 4.764391e+01, \
               4.017541e+01, 3.381001e+01, 2.836781e+01, 2.373041e+01, \
               1.979160e+01, 1.645710e+01, 1.364340e+01, 1.127690e+01, \
               9.292942e+00, 7.619842e+00, 6.216801e+00, 5.046801e+00, \
               4.076571e+00, 3.276431e+00, 2.620211e+00, 2.084970e+00, \
               1.650790e+00, 1.300510e+00, 1.019440e+00, 7.951341e-01, \
               6.167791e-01, 4.758061e-01, 3.650411e-01, 2.785261e-01, \
               2.113490e-01, 1.594950e-01, 1.197030e-01, 8.934502e-02, \
               6.600001e-02, 4.758501e-02, 3.270000e-02, 2.000000e-02, \
               1.000000e-02 /)

;; Bp [unitless] for 72 levels (73 edges)
b_in =      (/ 1.000000e+00, 9.849520e-01, 9.634060e-01, 9.418650e-01, \
               9.203870e-01, 8.989080e-01, 8.774290e-01, 8.560180e-01, \
               8.346609e-01, 8.133039e-01, 7.919469e-01, 7.706375e-01, \
               7.493782e-01, 7.211660e-01, 6.858999e-01, 6.506349e-01, \
               6.158184e-01, 5.810415e-01, 5.463042e-01, 4.945902e-01, \
               4.437402e-01, 3.928911e-01, 3.433811e-01, 2.944031e-01, \
               2.467411e-01, 2.003501e-01, 1.562241e-01, 1.136021e-01, \
               6.372006e-02, 2.801004e-02, 6.960025e-03, 8.175413e-09, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00, 0.000000e+00, 0.000000e+00, 0.000000e+00, \
               0.000000e+00 /)

;! Ap [hPa] for 74 levels (75 edges)
a_out =    (/   0.0000000,   2.7871507,   5.5743014,   8.3614521,  11.1486028,  \ 
                13.9357536,  16.7229043,  19.5100550,  22.2972057,  25.0843564, \ 
                27.8715071,  30.6586578,  33.4458085,  36.2329593,  39.0201100, \ 
                41.8087123,  44.6089278,  47.4534183,  50.4082336,  53.5662786, \ 
                57.0095710,  60.7533531,  64.7323011,  68.8549615,  73.0567364, \ 
                77.2969797,  81.5364973,  85.7346430,  89.8565776,  93.8754457, \ 
                97.7709243, 101.5277712, 105.1350991, 108.5878272, 111.8859556, \ 
               115.0302100, 118.0249453, 120.8854039, 123.6326345, 126.2811535, \ 
               128.8360417, 131.2987506, 133.6736353, 135.9708571, 138.2013035, \ 
               140.3700552, 142.4814670, 144.5457005, 146.5692881, 148.5464231, \ 
               150.4712991, 152.3497225, \ 
               154.1875000, 144.5468750, 135.1875000, 126.0781250, 117.1914062, \ ; LS1:(LM+1)
               108.5859375, 100.3671875,  92.5898438, \ 
               85.2265625, \ ; 2
               71.5546875, \ ; 2
               59.2226562, \ ; 2
               48.2226562, \ ; 2
               38.5546875, \ ; 2
               30.2226562, \ ; 2
               23.1875000, \ ; 2
               17.1896562, \ ; 4
                8.7353750, \ ; 4
                4.4119297, \ ; 4
                2.2207877, \ ; 4
                1.0427319, \ ; 4
                0.3168814, \ ; 4
                0.0320000, \ ; 4
                0.0020000 /)

;! Bp [unitless] for 74 levels (75 edges)
b_out =     (/1.00000000e0,  0.98192363e0,   0.96384725e0,  0.94577088e0, \
              0.92769451e0,  0.90961814e0,   0.89154176e0,  0.87346539e0, \
              0.85538902e0,  0.83731265e0,   0.81923627e0,  0.80115990e0, \
              0.78308353e0,  0.76500716e0,   0.74693078e0,  0.72884500e0, \
              0.71068389e0,  0.69223563e0,   0.67307185e0,  0.65259001e0, \
              0.63025815e0,  0.60597744e0,   0.58017154e0,  0.55343357e0, \
              0.52618250e0,  0.49868193e0,   0.47118607e0,  0.44395854e0, \
              0.41722528e0,  0.39116047e0,   0.36589591e0,  0.34153047e0, \
              0.31813474e0,  0.29574170e0,   0.27435132e0,  0.25395891e0, \
              0.23453623e0,  0.21598441e0,   0.19816694e0,  0.18098968e0, \
              0.16441967e0,  0.14844750e0,   0.13304493e0,  0.11814604e0, \
              0.10368024e0,  0.08961456e0,   0.07592077e0,  0.06253295e0, \
              0.04940875e0,  0.03658583e0,   0.02410183e0,  0.01191911e0, \
              0.00000000e0,  0.00000000e0,   0.00000000e0,  0.00000000e0, \ ;! 53
              0.00000000e0,  0.00000000e0,   0.00000000e0,  0.00000000e0, \
              0.00000000e0,  0.00000000e0,   0.00000000e0,  0.00000000e0, \
              0.00000000e0,  0.00000000e0,   0.00000000e0,  0.00000000e0, \
              0.00000000e0,  0.00000000e0,   0.00000000e0,  0.00000000e0, \
              0.00000000e0,  0.00000000e0,   0.00000000e0                   /)


PS_in = fps->PS(0,:,:)
PE_in  = new( (/ 12, nki_in,  nj, ni /), "float" )
PE_out = new( (/ 12, nki_out, nj, ni /), "float" )

do m=0,11
do k=0,nk_in
 PE_in(m,k,:,:) = PS_in * b_in(k) + a_in(k)
end do
do k=0,nk_out
 PE_out(m,k,:,:) = PS_in * b_out(k) + a_out(k)
end do
end do

P_in = 0.5 * ( PE_in(:,0:(nk_in-1),:,:) + PE_in(:,1:(nk_in),:,:) )
P_out = 0.5 * ( PE_out(:,0:(nk_out-1),:,:) + PE_out(:,1:(nk_out),:,:) )
P_in@units = "hPa"
P_out@units = "hPa"

delete(fps)

type = (/ "ProdLoss" /)

do i=0,dimsizes(type)-1
print("UCX_"+type(i)+".v11-02d.4x5.72L.nc")
fin  = addfile( "UCX_"+type(i)+".v11-02d.4x5.72L.nc", "r" )
system("if [ -f UCX_"+type(i)+".v11-02d.4x5.74L.nc ]; then rm UCX_"+type(i)+".v11-02d.4x5.74L.nc; fi")
fout = addfile( "./UCX_"+type(i)+".v11-02d.4x5.74L.nc", "c" )
vars = getfilevarnames( fin )

do v=0,dimsizes(vars)-1

if ( vars(v) .eq. "time" ) then
 continue
end if
if ( vars(v) .eq. "lev" ) then
 continue
end if
if ( vars(v) .eq. "ilev" ) then
 continue
end if
if ( vars(v) .eq. "lat" ) then
 continue
end if
if ( vars(v) .eq. "lon" ) then
 continue
end if
if ( vars(v) .eq. "hyam" ) then
 continue
end if
if ( vars(v) .eq. "hybm" ) then
 continue
end if
if ( vars(v) .eq. "hybi" ) then
 continue
end if
if ( vars(v) .eq. "hyai" ) then
 continue
end if
if ( vars(v) .eq. "P0" ) then
 continue
end if

X = fin->$vars(v)$

if ( dimsizes(dimsizes(X)) .eq. 3 .or. dimsizes(dimsizes(X)) .eq. 2 ) then
  ;; 2D-variable - just copy over
  fout->$vars(v)$ = (/ X /)
else
  ;; 3D-variable - regrid
  X2 = int2p_n_Wrap( P_in, X, P_out, -1, 1 )
  fout->$vars(v)$ = X2 ;(/ X2 /)
  delete(X2)
end if

delete(X)
  
end do ; var

delete(fout)
system("ncrename -d LEV,lev UCX_"+type(i)+".v11-02d.4x5.74L.nc")
system("ncap2 -O -s 'lev=array(1,1,$lev);' UCX_"+type(i)+".v11-02d.4x5.74L.nc UCX_"+type(i)+".v11-02d.4x5.74L.nc")

end do ; type

end
